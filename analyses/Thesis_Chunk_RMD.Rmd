---
title: "Bacterioplankton response to salinity (aka 2015 CSI Dispersal Experiment)"
author: "Alex Stucy, Jo Werba, Mike McCoy, Ariane Peralta"
date: "Last updated on `r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
  fig_caption: true
---
Project Description: Analysis of salinity and dispersal of saline aquatic communities on bacterial community structure and function.


Setting up working directory, packages
```{r (1)}
#PC - set WD manually by Session -> Set Working Directory -> Choose Directory...
rm(list = ls())

#Set source R tools
source("../bin/DiversityFunctions.R")
source("../bin/MothurTools.R")

#load req'd packages
require("vegan")
require("dplyr")
require("nlme")
require("reshape2")
require("ecodist")
require("ggplot2")
require("ade4")
require("png")
require("MASS")
require("grid")
require("ape")
require("png")
require("picante")

# set std err
se <- function(x, ...) {
sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))
}
ci <- function(x, ...) {
1.96 * sd(x, na.rm = TRUE)
}
```

Loading data files and manipulate data files for statistical analyses and graphing
```{r (2)}
# load design file - no source tanks
design.ns <- read.csv("../data/CSI_Design_ENV_NoSourceTanks.csv", row.names=1)
head(design.ns)
str(design.ns)
dim(design.ns)

# load design file - with source tanks but missing decomp, nutrients, sreal, Date2 columns
design.full <- read.csv("../data/design_CSI.csv", row.names=1)
design.full <- design.full[-c(grep("mock community", design.full$CSI_ID)), ]
dim(design.full)

# load OTU file
csi_otu <- read.otu("../data/CSI.shared")
dim(csi_otu)

# remove extra site (no mock community)

# design with source tanks
missing <- setdiff(rownames(design.full), rownames(csi_otu))
design.full <- design.full[-(which(rownames(design.full) == missing)), ]
dim(design.full)

# OTU table - remove otu's w/ < 2 occurrences across all sites
otu_removal <- csi_otu[, which(colSums(csi_otu) >= 2)]
dim(otu_removal)

aa <- (rowSums(otu_removal))
aa # CSI033-7180 reads CSI101=75 reads - removed

# OTU table - removed low abundance samples
csi_low_remov <- otu_removal[which(rowSums(otu_removal) >= 13000), ]
dim(csi_low_remov)

# OTU table - odd sites in bacterial composition data and remove in design file
odd.sites <- c("CSI033","CSI101")

otu_final <- csi_low_remov[setdiff(rownames(csi_low_remov), odd.sites), ]
design_final <- design.full[setdiff(rownames(design.full), odd.sites), ]
design.ns <- design.ns[setdiff(rownames(design.ns), odd.sites), ]

all.equal(rownames(design_final), rownames(otu_final))

# create presence/absence and relative abundance matrices
csi_pres_abs <- (otu_final > 0) * 1
csi_relabun <- otu_final
for (i in 1:dim(otu_final)[1]) {
csi_relabun[i, ] <- otu_final[i, ]/sum(otu_final[i,
])
}

# import taxonomy file for later
csi_tax <- read.tax(taxonomy = "../data/CSI.0.03.cons.taxonomy", format = "rdp", tax.levels = 6, col.tax = 3)

# bind design and bact files
csi.full <- cbind(design_final,csi_relabun)

# REMOVE source tanks from otu file
# REMOVE source tanks Number 1,2,3 from otu_final and use design.ns (manually removed source tanks)
temp <- rownames(design_final[which(design_final$Number %in% c(1,2,3)), ])
otu_final.ns <- otu_final[-(which(rownames(otu_final) %in% temp)), ]
dim(otu_final.ns)
dim(design.ns)

#drop missing data
missing <- setdiff(rownames(design.ns), rownames(otu_final.ns))
design.ns2 <- design.ns[-(which(rownames(design.ns) == missing)), ]
dim(design.ns2)

# Drop levels of factors that are no longer in data set 
design.ns.final <- droplevels(design.ns2)

all.equal(rownames(design.ns2), rownames(otu_final.ns))

csi.ns <- cbind(design.ns.final,otu_final.ns)

# Set treatments
treatments1 <- as.factor(design.ns.final$Salinity)
levels(treatments1) <- c("0","5","9","13")
treatments2 <- as.factor(design.ns.final$Dispersal)
levels(treatments2) <- c("2","3")

date_1 <- as.factor(design.ns.final$Date2)
```

Calculating Diversity Metrics
```{r (3)}
# Rarefy Abundances (min abundance is 13,240. We are sampling to 13,000)
min(rowSums(otu_final.ns))
otu.rarefy <- rrarefy(otu_final.ns, 13000)

# Calculate Shannon H' (called shannon) using full data set (WITH source tanks)
shannon <- diversity(otu.rarefy, "shannon")

# Species Richness
richness <- rowSums((otu.rarefy >= 1))

# Pielouâ€™s evenness
J <- shannon/log(specnumber(otu.rarefy[,-c(1:1)]))

# Dombined design,shannon,richness,evenness - no source tanks
csi_otu.div <- cbind(design.ns.final,shannon,richness,J)
```

(1) How does salinity/dispersal/date influence bacterial diversity?
-Calculate Shannon's H' (diversity metric) - no source tanks
-Run stat model diversity~dispersal|salinity|date

Supplemental Results:
Use full data set (with source tanks) #Maybe just subset source tanks into a separate figure with no stats (just use as supplemental)

Testing salinity x dispersal influence on DIVERSITY (no source tanks)
```{r (4)}
# run full parametric statistical model
shannon.lm <- lm(shannon ~ Dispersal*Salinity*Date+Dispersal*Salinity+Salinity*Date+Dispersal*Date+Dispersal+Salinity+Date, data = csi_otu.div)
shannon.lm
anova(shannon.lm)

# run linear regression measured salinity used instead of 'factor' salinity
shannon.reg <- lm(shannon~Salinity_real, data = csi_otu.div)
summary(shannon.reg)

## maybe use Werba code - discuss with Jo and McCoy

```

Plotting diversity metrics
```{r (5)}
# Graphing Shannon Diversity - Treatment Salinity
p <- ggplot(csi_otu.div, aes(x=Salinity, y=shannon, color=Dispersal))+geom_point()
p1=p+geom_smooth(method="lm",aes(fill=Dispersal))
p1 + theme_bw() 
p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=16,face="bold"), axis.text=element_text(size=14), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=14), panel.border = element_rect(colour = "black",size=1.25)) + theme(axis.ticks.length=unit(0.3,"cm")) + xlab("Salinity") + ylab("Shannon Diversity Index (H')") 
ggsave("../figures/shannon.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)

# Graphing Shannon Diversity x MEASURED Salinity

p <- ggplot(csi_otu.div, aes(x=Salinity_real, y=shannon, color=Dispersal))+geom_point()
p1=p+geom_smooth(method="lm",aes(fill=Dispersal))
p1 + theme_bw() 
p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=16,face="bold"), axis.text=element_text(size=14), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=14), panel.border = element_rect(colour = "black",size=1.25)) + theme(axis.ticks.length=unit(0.3,"cm")) + xlab("Salinity (measured)") + ylab("Shannon Diversity Index (H')") 
ggsave("../figures/shannon_SalReal.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)
```
(2) How does salinity/dispersal/date influence bacterial evenness?

```{r}
# run full parametric statistical model
J.lm <- lm(J ~ Dispersal*Salinity*Date+Dispersal*Salinity+Salinity*Date+Dispersal*Date+Dispersal+Salinity+Date, data = csi_otu.div)
J.lm
anova(J.lm)

# run linear regression measured salinity used instead of 'factor' salinity
J.reg <- lm(J~Salinity_real, data = csi_otu.div)
summary(J.reg)

# Graphing Pielous J - Treatment Salinity
p <- ggplot(csi_otu.div, aes(x=Salinity, y=J, color=Dispersal))+geom_point()
p1=p+geom_smooth(method="lm",aes(fill=Dispersal))
p1 + theme_bw() 
p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=16,face="bold"), axis.text=element_text(size=14), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=14), panel.border = element_rect(colour = "black",size=1.25)) + theme(axis.ticks.length=unit(0.3,"cm")) + xlab("Salinity") + ylab("Pielou's J") 
ggsave("../figures/pielousj.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)

# Graphing Pielous J x MEASURED Salinity

p <- ggplot(csi_otu.div, aes(x=Salinity_real, y=J, color=Dispersal))+geom_point()
p1=p+geom_smooth(method="lm",aes(fill=Dispersal))
p1 + theme_bw() 
p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=16,face="bold"), axis.text=element_text(size=14), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=14), panel.border = element_rect(colour = "black",size=1.25)) + theme(axis.ticks.length=unit(0.3,"cm")) + xlab("Salinity (measured)") + ylab("Pielou's J") 
ggsave("../figures/pielouj_SalReal.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)
```


(3) How does salinity/dispersal/date influence bacterial richness?

```{r}
# run full parametric statistical model
richness.lm <- lm(richness ~ Dispersal*Salinity*Date+Dispersal*Salinity+Salinity*Date+Dispersal*Date+Dispersal+Salinity+Date, data = csi_otu.div)
richness.lm
anova(richness.lm)

# run linear regression measured salinity used instead of 'factor' salinity
richness.reg <- lm(richness~Salinity_real, data = csi_otu.div)
summary(richness.reg)

# Graphing richness - Treatment Salinity
p <- ggplot(csi_otu.div, aes(x=Salinity, y=richness, color=Dispersal))+geom_point()
p1=p+geom_smooth(method="lm",aes(fill=Dispersal))
p1 + theme_bw() 
p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=16,face="bold"), axis.text=element_text(size=14), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=14), panel.border = element_rect(colour = "black",size=1.25)) + theme(axis.ticks.length=unit(0.3,"cm")) + xlab("Salinity") + ylab("richness") 
ggsave("../figures/richness.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)

# Graphing richness x MEASURED Salinity

p <- ggplot(csi_otu.div, aes(x=Salinity_real, y=shannon, color=Dispersal))+geom_point()
p1=p+geom_smooth(method="lm",aes(fill=Dispersal))
p1 + theme_bw() 
p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=16,face="bold"), axis.text=element_text(size=14), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=14), panel.border = element_rect(colour = "black",size=1.25)) + theme(axis.ticks.length=unit(0.3,"cm")) + xlab("Salinity (measured)") + ylab("richness") 
ggsave("../figures/richness_SalReal.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)
```


(4) How does salinity and dispersal influence carbon mineralization rates?
Calculate C mineralization rate (should be completed already in CSI shared folder)
Graph C mineralization
Run stat model Cmin~dispersal + salinity + dispersal*salinity

```{r (4 w source tanks)}
#import C-mineralization CSV -- no source tanks
carbon_min <- read.csv("../data/Cmin-data-NO-SOURCE.csv")

#experimental salinity
carbon.lm <- lm(ngCO2C_mL_day ~ Dispersal + Salinity + Dispersal*Salinity, data = carbon_min)
anova(carbon.lm)

#real salinity
real.carbon.lm <- lm(ngCO2C_mL_day ~ Dispersal + Sal_Real + Dispersal*Sal_Real, data = carbon_min)
anova(real.carbon.lm)

# run linear regression ('factor' salinity)
carbon.reg <- lm(ngCO2C_mL_day~Salinity, data = carbon_min)
summary(carbon.reg)

#linear regression (real salinity)
real.carbon.reg <- lm(ngCO2C_mL_day~Sal_Real, data = carbon_min)
summary(real.carbon.reg)

p <- ggplot(carbon_min, aes(x=Salinity, y=ngCO2C_mL_day, color=Dispersal))+geom_point()
p1=p+geom_smooth(method="lm",aes(fill=Dispersal))
p1 + theme_bw() 
p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=10,face="bold"), axis.text=element_text(size=8), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=8), panel.border = element_rect(colour = "black",size=1.25)) + theme(axis.ticks.length=unit(0.3,"cm")) + xlab("Salinity") + ylab("Carbon Mineralization (ng CO2/mL/day)") 
ggsave("../figures/carbon_mineralization.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)

p <- ggplot(carbon_min, aes(x=Sal_Real, y=ngCO2C_mL_day, color=Dispersal))+geom_point()
p1=p+geom_smooth(method="lm",aes(fill=Dispersal))
p1 + theme_bw() 
p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=10,face="bold"), axis.text=element_text(size=8), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=8), panel.border = element_rect(colour = "black",size=1.25)) + theme(axis.ticks.length=unit(0.3,"cm")) + xlab("Measured Salinity") + ylab("Carbon Mineralization (ng CO2/mL/day)") 
ggsave("../figures/real.sal.carbonmin.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=NA, height=NA, dpi=300, limitsize=TRUE)
```


(5) Which bacterial taxa are driving bacterial community patterns in response to salinity only?
Subset data (run without source tanks)
Bray-Curtis dissimilarity matrix for bacterial community
Run Species Indicator Analysis - see IL_Wetlands.Rmd file
Create Table for Supplemental (includes all taxa and associated taxon contribution to bacterial response)
Create subset in table format to highlight top 5-10 OTUs (with names) for each salinity tank type (or by whatever groupings seem interesting) - See AP's IL Wetlands paper

```{r (5)}
require("stats")
require("labdsv")
require("mgcv")
require("cluster")
require("vegan")
require("reshape2")
require("reshape")

#braycurtis
braycurtis.csi <- vegdist(csi_relabun, method="bray")
#pcoa
csi.pcoa <- cmdscale(braycurtis.csi, k=3, eig=TRUE, add=FALSE)

#remove odd sites
odd <- row.names(csi_relabun[c(abs(csi.pcoa$points[, 1]) > 0.3), ])
odd.odd <- csi_relabun[c(abs(csi.pcoa$points[, 1]) > 0.3), ]
mean(rowSums((csi_relabun > 0) * 1))
 #992.8889
rowSums((odd.odd > 0) * 1)

csi_relabun.2 <- csi_relabun[c(abs(csi.pcoa$points[, 1]) < 0.3), ]
design.2 <- design.ns[c(abs(csi.pcoa$points[, 1]) < 0.3), ]
treatment.salreal <- design.2$Salinity_real

#create dist matrix
csi.rel2 <- vegdist(csi_relabun.2, method="bray")

#principle coordinate analysis
csi_pcoa <- cmdscale(csi.rel2, k=2, eig=TRUE, add=FALSE)

explainvar1 <- round(csi_pcoa$eig[1] / sum(csi_pcoa$eig), 3) * 100
explainvar2 <- round(csi_pcoa$eig[2] / sum(csi_pcoa$eig), 3) * 100
sum.eig <- sum(explainvar1, explainvar2)

#plot
points <- cbind(as.data.frame(csi_pcoa$points), treatment.salreal)
L.centroids <- melt(points, id="treatment.salreal", measure.vars = c("V1", "V2"))
centroids <- cast(L.centroids, variable ~ treatment.salreal, mean)
centroids.se <- cast(L.centroids, variable ~ treatment.salreal, se)
centroids.sd <- cast(L.centroids, variable ~ treatment.salreal, sd)
cent.dataframe <- t(data.frame(rbind(centroids[1,-1], centroids[2,-1],
centroids.sd[1,-1],centroids.sd[2,-1])))
colnames(cent.dataframe) <- c("V1", "V2", "V1e", "V2e")
cent.treats <- rownames(cent.dataframe)

myColors <- c("#448844", "#33CC33", "#CCFF00", "#FFF000", "#FF9933", "#A9A9A9")
names(myColors) <- c("BalledBurlapped", "Bareroot", "Seedling",
"Acorn", "Seedbank", "Reference")

#define plot parameters
par(mar=c(5, 5.5, 1,1) + 0.1)
layout(matrix(1:2, 1, 1), widths=c(4,2))

plot(cent.dataframe[,1], cent.dataframe[,2], type = 'n', las = 1,
     xlim = c(-0.1, 0.1), ylim = c(-0.1,0.1),
     xaxt = "n", xlab = "", yaxt = "n", ylab="")
abline(h = 0, lty = 3, col = "gray")
abline(v = 0, lty = 3, col = "gray")

arrows(x0 = cent.dataframe[,1],
      y1 = cent.dataframe[,2] - cent.dataframe[,4],
      y0 = cent.dataframe[,2] + cent.dataframe[,4],
      angle = 90,
      length=0.1, lwd = 2, code = 3)
arrows(y0 = cent.dataframe[,2],
       x1 = cent.dataframe[,1] - cent.dataframe[,3],
       x0 = cent.dataframe[,1] + cent.dataframe[,3],
       angle = 90,
       length=0.1, lwd = 2, code = 3)
points(cent.dataframe[,1], cent.dataframe[,2],
       cex = 2.5, bg = myColors, col = "black", pch = 22, lwd = 2)

axis(side = 1, labels = T, las = 1, lwd.ticks = 2)
axis(side = 2, labels = T, las = 1, lwd.ticks = 2)
axis(side=1, lwd.ticks = 2, tck = -0.02, labels=F, cex.axis=1)
axis(side=3, lwd.ticks = 2, tck = -0.02, labels=F, cex.axis=1)
axis(side=1, lwd.ticks = 2, tck = 0.01, labels=F, cex.axis=1)
axis(side=3, lwd.ticks = 2, tck = 0.01, labels=F, cex.axis=1)
axis(side = 2, lwd.ticks = 2, tck = -0.02, labels=F, cex.axis=1)
axis(side = 4, lwd.ticks = 2, tck = -0.02, labels=F, cex.axis=1)
axis(side = 2, lwd.ticks = 2, tck = 0.01, labels=F, cex.axis=1)
axis(side = 4, lwd.ticks = 2, tck = 0.01, labels=F, cex.axis=1)

mtext(paste("PCoA 1 (", explainvar1, "%)", sep = ""), side = 1, line = 3, cex = 1.5)
mtext(paste("PCoA 2 (", explainvar2, "%)", sep = ""), side = 2, line = 3.5, cex = 1.5)
box(lwd = 2)

par(mar = c(5, 0, 1, 1) + 0.1)
plot.new()

legend(0, 1, c(treatment.salreal), pt.bg = myColors, col = "black", pch = 22, cex = 0.9, bty = 'n', inset = c(0.1, 0.05), y.intersp = 1.25, adj = 2)

dev.off()

graphics.off()
#NOTE the PCOA plot looks horrible -- lines overlap a lot -- how to fix??


#SPECIES INDICATOR ANALYSIS
csi.ns.indval <- read.csv("../data/csi.ns.indval.csv")
#ERROR REC'D : NOT MEANINGFUL FOR FACTORS : this won't work
csi.ind <- indval(csi.ns.indval,treatments1)


```



