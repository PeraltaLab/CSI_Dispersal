---
title: "R Notebook"
output: html_notebook
---

```{r}
rm(list = ls())
#set WD manually
```

```{r}
#Set Std Err and Conf Int
se <- function(x, ...) {
sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))
}
ci <- function(x, ...) {
1.96 * sd(x, na.rm = TRUE)
}

#Set Source R Tools
source("E:/Grad/Mothur/MothurTutorial.updated/MothurTutorial_updated/bin/DiversityFunctions.R")
source("E:/Grad/Mothur/MothurTutorial.updated/MothurTutorial_updated/bin/MothurTools.R")
```

```{r}
#load required packages
require("vegan")
require("dplyr")
require("nlme")
require("reshape")
require("BiodiversityR")
require("ecodist")
require("ggplot2")
require("ade4")
require("png")
```

```{r}
#load design file
design <- read.csv("E:/Grad/Mothur/mothur/design_CSI.csv", header=TRUE)
design

#set treatments (salinity levels)
treatments <- design$Salinity
levels(treatments) <- c("0","5","9","13")
```

```{r}
#import tax file
CSIdata <- read.otu("E:/Grad/Mothur/mothur/CSI.15.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.pick.opti_mcc.unique_list.shared")

#removed low samples (CSI033 had 7,204 and CSI101 had 77), remove blank and undetermined, remove OTUs w/ <2 occurrences across all sites
CSIdat <- CSIdata[which(rowSums(CSIdata) >= 20000), ]
CSIdata_use <- CSIdat[grepl("CSI[0-9][0-9]", rownames(CSI.dat)), ]
CSI.dat <- CSIdata_use[, which(colSums(CSIdat) >= 2)]

CSIdat

#create presence-absence matrix
CSIdataPA <- (CSI.dat > 0) * 1

#create relative abundance matrices
CSIdataREL <- CSI.dat
for (i in 1:dim(CSIdat)[1]) {
CSIdataREL[i, ] <- CSI.dat[i, ]/sum(CSI.dat[i,
2
])
}

#log transform relative abundances
CSIdataREL.log <- decostand(CSIdataREL, method = "log")
```


```{r}
#import taxonomy file
CSI.tax <- read.tax(taxonomy = "C:/Users/astuc/Documents/mothur/CSI.15.trim.contigs.good.unique.good.filter.unique.precluster.pick.pick.pick.opti_mcc.unique_list.0.03.cons.taxonomy")

CSI.tax

#create tax table .csv and export)
write.table(CSI.tax, file = "tax.csv", sep = ",",
col.names = NA)

```

```{r}
#find minimum abundance to set rarefy
a <- min(rowSums(CSI.dat))
a
```

```{r}
require("vegan")
#min abundance is 20,726, we will sample to 20,000
CSIdata.r <- rrarefy(CSI.dat, 20000)

# Fisher's Alpha
fisher <- fisher.alpha(CSIdata.r)
fisher

# Species Richness
richness <- rowSums((CSIdata.r >= 1))
richness

# Shannon Diversity (my function gets the same answer)
shannon <- diversity(CSIdata.r, "shannon")

# Simpson's Evenness
simp.even <- diversity(CSIdata.r, "simpson")

# original simpsons code unsuccessful ("simp.even <- apply(CSIdata.r, 1, simp_even)") ... returned error "function: simp_even not found"

#Pielou's evenness
J <- shannon/log(specnumber(CSIdata.r[,-c(1:1)]))

#combined richness, diversity, evenness
CSI.DIVaquamicrobes <- cbind(design,richness,shannon,simp.even,J)
write.table(CSI.DIVaquamicrobes, file="CSI.DIVaquamicrobes.csv", sep=",", col.names=NA)
```

```{r}
# Hypothesis Testing
# First Check the order
length(design$Salinity) == length(fisher)
all.equal(gsub("-", "", rownames(design)), names(fisher))

fisher.lm <- lme(fisher ~ Salinity, random = ~1|Tank_., data = design)
anova(fisher.lm)

richness.lm <- lme(richness ~ Salinity, random = ~1|Tank_., data = design)
anova(richness.lm)

evenness.lm <- lme(simp.even ~ Salinity, random = ~1|Tank_., data = design)
anova(evenness.lm)

shannon.lm <- lme(shannon ~ Salinity, random = ~1|Tank_., data = design)
anova(shannon.lm)

install.packages("agricolae")
library(agricolae)
summary(shannon.lm)
shannon.lm2 <- lm(shannon ~ Salinity, data = CSI.DIVaquamicrobes)
HSD <- HSD.test(shannon.lm2,"Salinity", console=TRUE)
```

```{r}
p <- ggplot(CSI.DIVaquamicrobes, aes(Salinity,shannon))
p + geom_boxplot() + theme_bw()
p + geom_boxplot() + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor =     element_blank(), axis.line = element_line(colour = "black")) +   
  theme(axis.title=element_text(vjust=1,size=16,face="bold"), axis.text=element_text(size=14), 
  axis.text.x = element_text(vjust=0.65, hjust=0.5, angle=30, size=14), panel.border =   
  element_rect(colour = "black",size=1.25)) + theme(axis.ticks.length=unit(0.3,"cm")) + 
  xlab("Microbial Diversity") + ylab("Shannon Diversity Index (H')") + 
  scale_x_discrete(breaks=c("0","5","9","13"),   
  labels=c("0","5","9","13"))
```

```{r}
new.data <-cbind(design,CSIdataREL)
adonis = adonis(new.data[,-c(1:15)] ~ Salinity+Tank_., method = "bray", data = new.data, perm=1000)
adonis
```

```{r}
sampleREL.dist <- vegdist(CSIdataREL, method="bray")

# Principal Coordinates Analysis
CSI_pcoa <- cmdscale(sampleREL.dist, k=3, eig=TRUE, add=FALSE)
  # Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
  # eig=TRUE returns eigenvalues; k = # of dimensions to calculate

explainvar1 <- round(CSI_pcoa$eig[1] / sum(CSI_pcoa$eig), 3) * 100
explainvar2 <- round(CSI_pcoa$eig[2] / sum(CSI_pcoa$eig), 3) * 100
sum.eig <- sum(explainvar1, explainvar2)

explainvar1
explainvar2
```

```{r}
points <- cbind(as.data.frame(CSI_pcoa$points), treatments)
L.centroids <- melt(points, id="treatments", measure.vars = c("V1", "V2"))
centroids <- cast(L.centroids, variable ~ treatments, mean)
centroids.se <- cast(L.centroids, variable ~ treatments, se)
centroids.sd <- cast(L.centroids, variable ~ treatments, sd)

cent.dataframe <- t(data.frame(rbind(centroids[1,-1], centroids[2,-1],
                             centroids.sd[1,-1],centroids.sd[2,-1])))
colnames(cent.dataframe) <- c("V1", "V2", "V1e", "V2e")
cent.treats <- rownames(cent.dataframe)
```

```{r}
df <- as.data.frame(cent.dataframe)
p <- ggplot(df, aes(x=V1, y=V2, colour=cent.treats)) + theme_bw() 
p + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) + 
theme(panel.background = element_blank()) + 
  geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e, height=0.01), colour="black") +    
  geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e, width=0.01), colour="black") + 
  geom_point(size=5) +
  scale_colour_manual(labels = c("0","5","9","13"),   values = c("#FFFFCC", "#FFFF00", "#FF9933", "#66CC00")) +
  geom_point(shape=1, size = 5,colour = "black") +
theme(axis.title=element_text(size=18), axis.text=element_text(size=14), axis.text.x   = element_text(size=14), panel.border = element_rect(colour = "black",size=1.25)) + 
  theme(axis.ticks.length=unit(0.3,"cm")) + 
  xlab("PCoA 1 (19.4%)") + ylab("PCoA 2 (6.0%)") + 
  labs(color = "Microbial Diversity") +
  guides(colour = guide_legend(override.aes = list(pch=21, size = 4, colour="black",    
  fill=c("#FFFFCC", "#FFFF00", "#FF9933", "#66CC00")))) 
```

